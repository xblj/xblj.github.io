<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实现 html-webpack-plugin | 前端学习笔记</title>
    <meta name="description" content="用于记录前端学习记录">
    
    
    <link rel="preload" href="/assets/css/0.styles.3e51a216.css" as="style"><link rel="preload" href="/assets/js/app.f1ceba08.js" as="script"><link rel="preload" href="/assets/js/2.83eeaff2.js" as="script"><link rel="preload" href="/assets/js/19.52c8315b.js" as="script"><link rel="prefetch" href="/assets/js/10.6f593b9b.js"><link rel="prefetch" href="/assets/js/11.f71b7c09.js"><link rel="prefetch" href="/assets/js/12.0496153c.js"><link rel="prefetch" href="/assets/js/13.16389641.js"><link rel="prefetch" href="/assets/js/14.8ace6ca5.js"><link rel="prefetch" href="/assets/js/15.6a96251c.js"><link rel="prefetch" href="/assets/js/16.82da399a.js"><link rel="prefetch" href="/assets/js/17.a6b25da3.js"><link rel="prefetch" href="/assets/js/18.bb157b26.js"><link rel="prefetch" href="/assets/js/20.d7f12b74.js"><link rel="prefetch" href="/assets/js/21.7d05b1b9.js"><link rel="prefetch" href="/assets/js/22.cf7dfbae.js"><link rel="prefetch" href="/assets/js/3.5678b3c2.js"><link rel="prefetch" href="/assets/js/4.28cbff14.js"><link rel="prefetch" href="/assets/js/5.55a60148.js"><link rel="prefetch" href="/assets/js/6.53bdd743.js"><link rel="prefetch" href="/assets/js/7.618a7261.js"><link rel="prefetch" href="/assets/js/8.62bd8d80.js"><link rel="prefetch" href="/assets/js/9.ed6fc6af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3e51a216.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack" class="dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/html-webpack-plugin.html" class="nav-link router-link-exact-active router-link-active">html-webpack-plugin分析实现</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="react" class="dropdown-title"><span class="title">react</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/redux/" class="nav-link">redux</a></li></ul></div></div><div class="nav-item"><a href="/other/" class="nav-link">杂记</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack" class="dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/html-webpack-plugin.html" class="nav-link router-link-exact-active router-link-active">html-webpack-plugin分析实现</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="react" class="dropdown-title"><span class="title">react</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/redux/" class="nav-link">redux</a></li></ul></div></div><div class="nav-item"><a href="/other/" class="nav-link">杂记</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="实现-html-webpack-plugin"><a href="#实现-html-webpack-plugin" class="header-anchor">#</a> 实现 html-webpack-plugin</h1> <p>本实现借鉴<a href="https://github.com/jantimon/html-webpack-plugin" target="_blank" rel="noopener noreferrer">https://github.com/jantimon/html-webpack-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的实现思路，并未完全按照前者实现，也不试用与生产环境，仅仅只为了学习 webpack 插件。</p> <h2 id="预备知识"><a href="#预备知识" class="header-anchor">#</a> 预备知识</h2> <ul><li><a href="https://webpack.js.org/api/compiler-hooks/" target="_blank" rel="noopener noreferrer">compiler 对象<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <blockquote><p>使用<code>cli</code>和<code>node api</code>所传递的配置创建<code>compilation</code>的主要引擎，整个编译过程只会被实例一次。</p></blockquote> <ul><li><a href="https://webpack.js.org/api/compilation-hooks/" target="_blank" rel="noopener noreferrer">compilation 对象<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <blockquote><p>代表一次构建，开发环境时，每次文件改变就会创建一个新的 <code>compilation</code> 对象，产生新的输出文件。</p></blockquote> <ul><li><a href="https://webpack.js.org/api/stats/" target="_blank" rel="noopener noreferrer">stats 对象<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <blockquote><p>当 webpack 在编译源代码时，我们可以生成一个描述模块的<code>JSON</code>文件，可以用来分析依赖情况。</p></blockquote> <ol><li>命令行生成：</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>webpack --profile --json <span class="token operator">&gt;</span> compilation-stats.json
</code></pre></div><ol start="2"><li>可以在 compilation 获取</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> json <span class="token operator">=</span> compilation<span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>下面列出三个比较常用的属性，也是我们本次需要用到的属性</p> <table><thead><tr><th>字段</th> <th>含义</th></tr></thead> <tbody><tr><td>modules</td> <td>记录了所有解析后的模块，简单的理解就是一个文件就是一个模块</td></tr> <tr><td>chunks</td> <td>记录了所有 chunk，多个模块可以合成为一个 chunk</td></tr> <tr><td>assets</td> <td>记录了所有要生成的文件</td></tr></tbody></table> <ul><li>子编译</li></ul> <blockquote><p><code>childCompiler</code>和<code>compiler</code>都是<code>Compiler</code>的实例，在<code>childCompiler</code>实例化后，会复制<code>compiler</code>上的钩子到<code>childCompiler</code>上，除了如下的：&quot;make&quot;, &quot;compile&quot;, &quot;emit&quot;, &quot;afterEmit&quot;, &quot;invalid&quot;, &quot;done&quot;, &quot;thisCompilation&quot;</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建一个子compiler</span>
<span class="token keyword">const</span> childCompiler <span class="token operator">=</span> compilation<span class="token punctuation">.</span><span class="token function">createChildCompiler</span><span class="token punctuation">(</span>
  <span class="token comment">// childCompiler的名称，便于debug</span>
  compilerName<span class="token punctuation">,</span>
  outputOptions<span class="token punctuation">,</span>
  <span class="token comment">// 应用到childCompiler上的插件</span>
  plugins
<span class="token punctuation">)</span><span class="token punctuation">;</span>
childCompiler<span class="token punctuation">.</span><span class="token function">runAsChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> entries<span class="token punctuation">,</span> childCompilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="插件书写规范"><a href="#插件书写规范" class="header-anchor">#</a> 插件书写规范</h2> <p>插件结构很简单，就两条规则：</p> <ol><li>定义一个类</li> <li>类有一个<code>apply</code>方法</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">HelloWebpackPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="实现思路"><a href="#实现思路" class="header-anchor">#</a> 实现思路</h2> <ol><li><p>我们要在构建之后新产生一个<code>index.html</code>文件，那么我们必须在 <code>webpack</code> 输出文件到输出目录之前时候告诉 <code>webpack</code> 我们需要将<code>index.html</code>添加到输出目录中。</p></li> <li><p>那如何告诉 <code>webpack</code> 呢？</p> <ul><li><code>webpack</code> 的输出文件都会挂载<code>compilation.assets</code>上，如果需要添加或者删除文件，可以直接对该属性进行操作</li></ul></li> <li><p>知道了如何在输出目录中添加文件，那什么时候添加呢？</p> <ul><li><code>webpack</code> 在将所有文件编译完成之后会触发<code>compiler</code>对象上的<code>emit</code>钩子，这是增删改文件的最后时机，所以我们可以在这个钩子内进行添加</li></ul></li> <li><p>html 内容怎么来呢？</p> <ul><li><ol><li>根据准备一个<a href="#%E9%BB%98%E8%AE%A4%E6%A8%A1%E6%9D%BF">默认模板</a>或者自定义一个模板，由于 <code>webpack</code> 只认识 js 文件，我们要让 <code>webpack</code> 能处理我们的准备的 html 模板，那么需要一个额外的<a href="#loader">loader</a> 来处理这个 html 文件</li></ol></li> <li><ol start="2"><li>我们是在父编译流程外去添加一个 html 文件，所以我们可以应用<a href="#%E5%AD%90%E7%BC%96%E8%AF%91">子编译</a>来编译 html，然后将编译完成的内容添加到父级<code>compilation.assets</code>上</li></ol></li></ul></li> <li><p>需要添加到 html 文件中的资源从哪来？</p> <ol><li><p>资源一般分为两种 css 样式文件和 js 脚本文件，分别对应标签：</p> <ul><li>css: <code>&lt;link rel=&quot;stylesheet&quot; href=&quot;xxx.css&quot;&gt;</code></li> <li>js: <code>&lt;script src=&quot;xxxx.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</code></li></ul></li> <li><p>所有输出的代码块都在<code>stats</code>对象的<code>chunks</code>属性(可以通过<code>compilation.getStats().toJson().chunks</code>拿到)上，筛选出首屏加载的<code>js</code>和<code>css</code>文件</p></li></ol></li> <li><p>然后就比较简单了，就是各种组装<code>js</code>和<code>css</code>标签, 具体见如下实现<a href="#%E4%B8%BB%E6%A8%A1%E5%9D%97">主模块</a></p></li></ol> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <h3 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h3> <div class="language- extra-class"><pre class="language-text"><code>|-- root
    |-- template.html
    |-- index.js
    |-- lib
        |-- compiler.js
        |-- loader.js

</code></pre></div><h3 id="默认模板"><a href="#默认模板" class="header-anchor">#</a> 默认模板</h3> <blockquote><p>./template.html</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>html webpack plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></code></pre></div><h3 id="主模块"><a href="#主模块" class="header-anchor">#</a> 主模块</h3> <blockquote><p>./index.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cheerio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cheerio'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncSeriesWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> childCompiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/compiler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @typedef {import('webpack/lib/Compilation')} Compilation
 */</span>

<span class="token comment">/**
 * @typedef {import('webpack/lib/Chunk')} Chunk
 */</span>

<span class="token comment">/**
 * @typedef {Object} Assets
 * @property {Array&lt;string&gt;} js
 * @property {Array&lt;string&gt;} css
 */</span>

<span class="token comment">/**
 * @typedef {Object} AssetTag
 * @property {string} tagName
 * @property {boolean} selfClose
 * @property {Object} attributes
 */</span>

<span class="token comment">/**
 * @typedef {Object} AssetTagObj
 * @property {AssetTag} head
 * @property {AssetTag} body
 */</span>

<span class="token keyword">const</span> <span class="token constant">PLUGIN_ID</span> <span class="token operator">=</span> <span class="token string">'HtmlWebpackPlugin'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HtmlWebpackPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span>
      template<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./template.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>options<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> compilationPromise<span class="token punctuation">;</span>
    <span class="token comment">// 将摸板相对地址改写为添加了loader处理的绝对路径, a.html =&gt; a-loader!b-loader!c:\\xxx\a.html</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>template <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFullTemplatePath</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>template<span class="token punctuation">,</span>
      compiler<span class="token punctuation">.</span>context
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token constant">PLUGIN_ID</span><span class="token punctuation">,</span> <span class="token parameter">compilation</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>htmlWebpackPluginAlterAssetTags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token string">'assetTags'</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token constant">PLUGIN_ID</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      compilationPromise <span class="token operator">=</span> childCompiler
        <span class="token punctuation">.</span><span class="token function">compileTemplate</span><span class="token punctuation">(</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>template<span class="token punctuation">,</span>
          compiler<span class="token punctuation">.</span>context<span class="token punctuation">,</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
          compilation
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">compilationResult</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>childCompilerHash <span class="token operator">=</span> compilationResult<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>childCompilationOutputName <span class="token operator">=</span> compilationResult<span class="token punctuation">.</span>outputName<span class="token punctuation">;</span>
          <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 编译之后的代码</span>
          <span class="token keyword">return</span> compilationResult<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token constant">PLUGIN_ID</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// const applyPluginsAsyncWaterfall = this.applyPluginsAsyncWaterfall(</span>
      <span class="token comment">//   compilation</span>
      <span class="token comment">// );</span>

      <span class="token keyword">let</span> <span class="token punctuation">{</span> chunks <span class="token punctuation">}</span> <span class="token operator">=</span> compilation<span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 过滤不需要写入html文件中的chunk</span>
      chunks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filterChunks</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 根据过滤后的chunks组装对应的css和js资源:30</span>
      <span class="token keyword">const</span> assets <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">htmlWebpackPluginAssets</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 等待子编译完成</span>
        <span class="token keyword">let</span> compiledTemplate <span class="token operator">=</span> <span class="token keyword">await</span> compilationPromise<span class="token punctuation">;</span>
        <span class="token comment">// 直接返回html文件，省略</span>
        <span class="token keyword">let</span> compilationResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">evaluateCompilationResult</span><span class="token punctuation">(</span>
          compilation<span class="token punctuation">,</span>
          compiledTemplate
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 执行模板函数，替换模板中的变量</span>
        <span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeTemplate</span><span class="token punctuation">(</span>
          compilationResult<span class="token punctuation">,</span>
          chunks<span class="token punctuation">,</span>
          assets<span class="token punctuation">,</span>
          compilation
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据资源生成要插入到html文件中的标签</span>
        <span class="token keyword">let</span> assetTags <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateHtmlTags</span><span class="token punctuation">(</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span>

        assetTags <span class="token operator">=</span> <span class="token keyword">await</span> compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>htmlWebpackPluginAlterAssetTags<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span>
          assetTags
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将标签插入到html中</span>
        html <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">injectAssetTagsIntoHtml</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> assetTags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将需要输出到文件系统的添加到assets上</span>
        compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>childCompilationOutputName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token function-variable function">source</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> html<span class="token punctuation">,</span>
          <span class="token function-variable function">size</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> html<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 获取配置文件中的模板参数
   * @param {Compilation} compilation
   * @param {assets} assets
   */</span>
  <span class="token function">getTemplateParameters</span><span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> assets</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> templateParameters <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> templateParameters <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">templateParameters</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> assets<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> templateParameters <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> templateParameters<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 执行模板函数，将配置里面的变量插入到html中
   * @param {Function} templateFunction
   * @param {Array} chunks
   * @param {Assets} assets
   * @param {Compilation} compilation
   * @returns {string} html文件内容
   */</span>
  <span class="token function">executeTemplate</span><span class="token punctuation">(</span><span class="token parameter">templateFunction<span class="token punctuation">,</span> chunks<span class="token punctuation">,</span> assets<span class="token punctuation">,</span> compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> templateParams <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTemplateParameters</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">templateFunction</span><span class="token punctuation">(</span>templateParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> html<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 执行
   * @param {Compilation} compilation
   * @param {string} source 经过loader处理后的代码
   * @returns {Function} 用于生成html文件内容的函数
   */</span>
  <span class="token function">evaluateCompilationResult</span><span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    source <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'var HTML_WEBPACK_PLUGIN_RESULT ='</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 源码中是在vm沙盒中运行，不是我们的学习的重点，为了简单就直接通过eval运行</span>
    <span class="token keyword">return</span> <span class="token function">eval</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 将js/css资源添加到html文件模板中
   * @param {string} temp html文件模板
   * @param {AssetTagObj} assetTags
   */</span>
  <span class="token function">injectAssetTagsIntoHtml</span><span class="token punctuation">(</span><span class="token parameter">temp<span class="token punctuation">,</span> assetTags</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> head<span class="token punctuation">,</span> body <span class="token punctuation">}</span> <span class="token operator">=</span> assetTags<span class="token punctuation">;</span>
    <span class="token keyword">const</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">generateElement</span> <span class="token operator">=</span> <span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>tagName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>attributes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">attr</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        str <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>attr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>selfClose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 自闭合标签</span>
        str <span class="token operator">+=</span> <span class="token string">' /&gt;'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        str <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&gt;&lt;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>tagName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>generateElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>generateElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 根据资源生成插入到html文件中的标签对象
   * @param {Assets} assets
   * @returns {AssetTagObj}
   */</span>
  <span class="token function">generateHtmlTags</span><span class="token punctuation">(</span><span class="token parameter">assets</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> js<span class="token punctuation">,</span> css <span class="token punctuation">}</span> <span class="token operator">=</span> assets<span class="token punctuation">;</span>
    <span class="token keyword">const</span> head <span class="token operator">=</span> css<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">stylePath</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        tagName<span class="token operator">:</span> <span class="token string">'link'</span><span class="token punctuation">,</span>
        selfClose<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        attributes<span class="token operator">:</span> <span class="token punctuation">{</span>
          href<span class="token operator">:</span> stylePath<span class="token punctuation">,</span>
          rel<span class="token operator">:</span> <span class="token string">'stylesheet'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> body <span class="token operator">=</span> js<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">scriptPath</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        tagName<span class="token operator">:</span> <span class="token string">'script'</span><span class="token punctuation">,</span>
        selfClose<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        attributes<span class="token operator">:</span> <span class="token punctuation">{</span>
          src<span class="token operator">:</span> scriptPath<span class="token punctuation">,</span>
          type<span class="token operator">:</span> <span class="token string">'text/javascript'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      head<span class="token punctuation">,</span>
      body<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 筛选时出js和css文件
   * @param {Array&lt;Chunk&gt;} chunks
   * @returns {Assets}
   */</span>
  <span class="token function">htmlWebpackPluginAssets</span><span class="token punctuation">(</span><span class="token parameter">chunks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> assets <span class="token operator">=</span> <span class="token punctuation">{</span>
      js<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      css<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    chunks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">chunk</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token function-variable function">filterFile</span> <span class="token operator">=</span> <span class="token parameter">reg</span> <span class="token operator">=&gt;</span> <span class="token parameter">file</span> <span class="token operator">=&gt;</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> js <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">filterFile</span><span class="token punctuation">(</span><span class="token regex">/\.js$/</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> css <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">filterFile</span><span class="token punctuation">(</span><span class="token regex">/\.css$/</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>js<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        assets<span class="token punctuation">.</span>js<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>js<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>css<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        assets<span class="token punctuation">.</span>css<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>css<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> assets<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 过滤出不需要插入到页面中的chunk
   * @param {Array&lt;Chunk&gt;} chunks
   * @returns {Array&lt;Chunk&gt;}
   * @example
   * 比如动态导入的模块不会插入到页面
   * import('module').then(res =&gt; ...)
   */</span>
  <span class="token function">filterChunks</span><span class="token punctuation">(</span><span class="token parameter">chunks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> chunks<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">chunk</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>
        names<span class="token operator">:</span> <span class="token punctuation">[</span>chunkName<span class="token punctuation">]</span><span class="token punctuation">,</span>
        initial<span class="token punctuation">,</span>
      <span class="token punctuation">}</span> <span class="token operator">=</span> chunk<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunkName <span class="token operator">||</span> <span class="token operator">!</span>initial<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 将模板相对路径改为绝对路径
   * @param {string} template 相对路径
   * @param {string} context 当前上下文
   * @returns {string}
   * @example
   * 输入：
   * 'a-loader!a-loader!path.js?query=2'
   * 返回：
   * 'a-loader!a-loader!c://xxx/xx/path.js?query=2';
   */</span>
  <span class="token function">getFullTemplatePath</span><span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 若果没有设置加载模板的loader，那么就使用默认的loader</span>
      template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./lib/loader.js'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        template
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将相对路径修改为绝对路径</span>
    <span class="token keyword">return</span> template<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
      <span class="token regex">/([!])([^/\\][^!?]+|[^/\\!?])($|\?[^!?\n]+$)/</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> filepath<span class="token punctuation">,</span> postfix</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        prefix <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span> <span class="token operator">+</span> postfix
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 异步钩子函数触发帮助函数
   * @param {Compilation} compilation
   */</span>
  <span class="token function">applyPluginsAsyncWaterfall</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> requiresResult<span class="token punctuation">,</span> pluginArgs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span>pluginArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HtmlWebpackPlugin<span class="token punctuation">;</span>
</code></pre></div><h3 id="子编译"><a href="#子编译" class="header-anchor">#</a> 子编译</h3> <blockquote><p>./lib/compiler.js</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NodeTemplatePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/node/NodeTemplatePlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NodeTargetPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/node/NodeTargetPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> LibraryTemplatePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/LibraryTemplatePlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> SingleEntryPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/SingleEntryPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> LoaderTargetPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/LoaderTargetPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @typedef {import('webpack/lib/Compilation')} Compilation
 */</span>

<span class="token comment">/**
 *
 * @param {string} template
 * @param {string} context 当前构建上线文
 * @param {string} outputFilename 输出文件名
 * @param {Compilation} compilation
 */</span>
<span class="token keyword">function</span> <span class="token function">compileTemplate</span><span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> context<span class="token punctuation">,</span> outputFilename<span class="token punctuation">,</span> compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> outputOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> outputFilename<span class="token punctuation">,</span>
    publicPath<span class="token operator">:</span> compilation<span class="token punctuation">.</span>outputOptions<span class="token punctuation">.</span>publicPath
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 每个子编译都需要一个名字，便于区分
   */</span>
  <span class="token keyword">const</span> compilerName <span class="token operator">=</span> <span class="token function">getCompilerName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> outputFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 创建子编译对象</span>
  <span class="token keyword">const</span> childCompiler <span class="token operator">=</span> compilation<span class="token punctuation">.</span><span class="token function">createChildCompiler</span><span class="token punctuation">(</span>
    compilerName<span class="token punctuation">,</span>
    outputOptions
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果不重写context会使用父级compiler.context</span>
  childCompiler<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>

  <span class="token comment">// 主要是生成能在node环境中运行的代码，如果我们在webpack.config.js的target设置了node/async-node那么就会默认调用这个插件</span>
  <span class="token keyword">new</span> <span class="token class-name">NodeTemplatePlugin</span><span class="token punctuation">(</span>outputOptions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>childCompiler<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 主要是引用node的内置模块依赖，比如我们会在代码中用到fs等内置模块，如果不调用这个插件，那么webpack会出现找不到模块</span>
  <span class="token comment">// 解析模块规则： https://www.webpackjs.com/concepts/module-resolution/</span>
  <span class="token keyword">new</span> <span class="token class-name">NodeTargetPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>childCompiler<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将源代码运行的结果赋值到var HTML_WEBPACK_PLUGIN_RESULT 变量上， 在我们实现中没什么用，后面会替换掉</span>
  <span class="token keyword">new</span> <span class="token class-name">LibraryTemplatePlugin</span><span class="token punctuation">(</span><span class="token string">'HTML_WEBPACK_PLUGIN_RESULT'</span><span class="token punctuation">,</span> <span class="token string">'var'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
    childCompiler
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 编译的入口插件，webpack编译从这个地方开始，以此递归构建每个依赖</span>
  <span class="token keyword">new</span> <span class="token class-name">SingleEntryPlugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span> template<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>childCompiler<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 主要是做了一件事，就是设置loaderContext.target属性，如果loader可以多环境运行，那么可以通过这个插件设置</span>
  <span class="token keyword">new</span> <span class="token class-name">LoaderTargetPlugin</span><span class="token punctuation">(</span><span class="token string">'web'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>childCompiler<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    childCompiler<span class="token punctuation">.</span><span class="token function">runAsChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> entries<span class="token punctuation">,</span> childCompilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用于将配置的hash，contenthash等名称替换</span>
        <span class="token keyword">const</span> outputName <span class="token operator">=</span> compilation<span class="token punctuation">.</span>mainTemplate<span class="token punctuation">.</span><span class="token function">getAssetPath</span><span class="token punctuation">(</span>
          outputOptions<span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            hash<span class="token operator">:</span> childCompilation<span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
            chunk<span class="token operator">:</span> entries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          hash<span class="token operator">:</span> entries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
          outputName<span class="token punctuation">,</span>
          content<span class="token operator">:</span> childCompilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>outputName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 每个子编译都需要一个名称
 * @param {string} context
 * @param {string} filename
 * @returns {string} 'html-webpack-plugin for &quot;index.html&quot;
 */</span>
<span class="token keyword">function</span> <span class="token function">getCompilerName</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> absolutePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> relativePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token string">'html-webpack-plugin for &quot;'</span> <span class="token operator">+</span>
    <span class="token punctuation">(</span>absolutePath<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> relativePath<span class="token punctuation">.</span>length <span class="token operator">?</span> absolutePath <span class="token operator">:</span> relativePath<span class="token punctuation">)</span> <span class="token operator">+</span>
    <span class="token string">'&quot;'</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>compileTemplate <span class="token operator">=</span> compileTemplate<span class="token punctuation">;</span>
</code></pre></div><h3 id="loader"><a href="#loader" class="header-anchor">#</a> loader</h3> <blockquote><p>./lib/loader</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> template <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    variable<span class="token operator">:</span> <span class="token string">'data'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 以下是源码中的写法，但是我们使用eval来运行代码，会有严格模式，不允许使用with，所以改成下面的方式</span>
  <span class="token comment">// 下面这样的好处是，我们在模板中不需要通过data.foo获取属性，直接书写foo就行</span>
  <span class="token comment">// return `</span>
  <span class="token comment">//  module.exports = function (templateParams) {</span>
  <span class="token comment">//    with(templateParams) {</span>
  <span class="token comment">//      return (${template.source})()</span>
  <span class="token comment">//    }</span>
  <span class="token comment">//  }</span>
  <span class="token comment">// `;</span>

  <span class="token comment">// new LoaderTargetPlugin('web').apply(childCompiler);</span>
  <span class="token comment">// console.log(this.target);</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    // !! 表示不需要其他loader去处理
    var _ = require('!!lodash');
    module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token punctuation">.</span>source<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f1ceba08.js" defer></script><script src="/assets/js/2.83eeaff2.js" defer></script><script src="/assets/js/19.52c8315b.js" defer></script>
  </body>
</html>
